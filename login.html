<!doctype html>
<html lang="ja">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Login</title>
    <script src="https://accounts.google.com/gsi/client" defer></script>
    <style>
      body {
        font-family:
          system-ui,
          -apple-system,
          sans-serif;
        padding: 24px;
        font-size: 16px;
        line-height: 1.6;
      }
      .box {
        max-width: 520px;
        margin: 0 auto;
      }
      .err {
        color: #b00020;
        white-space: pre-wrap;
      }
      #g_id_signin {
        transform-origin: left top;
      }
      @media (max-width: 600px) {
        body {
          padding: 32px;
          font-size: 18px;
        }
        h1 {
          font-size: 1.6rem;
        }
        #g_id_signin {
          transform: scale(1.1);
        }
      }
      @media (max-width: 420px) {
        body {
          font-size: 19px;
        }
        #g_id_signin {
          transform: scale(1.18);
        }
      }
    </style>
  </head>
  <body>
    <div class="box">
      <h1>ログイン</h1>
      <p id="msg">読み込み中…</p>
      <div id="g_id_signin"></div>
      <pre id="err" class="err"></pre>
    </div>

    <script>
      // ★自分のOAuthクライアントIDに差し替え
      const CLIENT_ID =
        "751076521932-rbmj256c9be0p0jq45n1btido0pkv7t8.apps.googleusercontent.com";

      /**
       * return の許可リスト（最小・最強）
       * - "あなたの WebApp の /exec" に完全一致するものだけ許可
       * - かつ page=auth を必須
       *
       * 例:
       *   https://script.google.com/macros/s/AKfycbXXXXXXXXXXXX/exec
       *
       * ⚠ 新しいデプロイを作ってURLが変わる運用だと、ここも更新が必要になる。
       *    できれば「既存デプロイを編集（URL固定）」で運用するのが安全。
       */
      const ALLOWED_EXEC_BASE_URLS = new Set([
        // TODO: あなたの本番 /exec
        "https://script.google.com/macros/s/AKfycbwH35heJuJrxDdtGTZ8ri_Frg-1pCJnNbzoQIyFvGVo-p4uuy5SyKRet7IzDlfx86f0/exec",
        // TODO: 開発があるなら追加
        // "https://script.google.com/macros/s/AKfycbyJPnsBEgF1HvcWi4yA-D5FOhISvujShjltbkL8tJdzsTf4VXi7Y39llPUocKPbddoa/exec",
      ]);

      const params = new URLSearchParams(location.search);
      const returnUrl = params.get("return") || "";

      function isAllowedReturn(raw) {
        let u;
        try {
          u = new URL(raw);
        } catch {
          return false;
        }

        // https 以外は拒否
        if (u.protocol !== "https:") return false;

        // 許可する origin は script.google.com のみ（広げない）
        if (u.origin !== "https://script.google.com") return false;

        // /exec のベースURLが許可リストに完全一致すること
        const execBase = `${u.origin}${u.pathname}`;
        if (!ALLOWED_EXEC_BASE_URLS.has(execBase)) return false;

        // return 先は auth ページだけ許可
        if (u.searchParams.get("page") !== "auth") return false;

        // login.html が付与するので、return 自体に id_token が入っていたら拒否
        if (u.searchParams.has("id_token")) return false;

        // 余計なクエリを混ぜられないようにキーを制限（必要ならここで追加）
        const allowedKeys = new Set(["page", "next", "nextQuery"]);
        for (const k of u.searchParams.keys()) {
          if (!allowedKeys.has(k)) return false;
        }

        // hash が付いていたら拒否（意図しない遷移に使える）
        if (u.hash) return false;

        return true;
      }

      const msg = document.getElementById("msg");
      const err = document.getElementById("err");

      if (!returnUrl) {
        msg.textContent = "return パラメータがありません。";
      } else if (!isAllowedReturn(returnUrl)) {
        msg.textContent = "return が許可されていません。";
        err.textContent = "return=" + returnUrl;
      } else {
        msg.textContent = "Googleでログインしてください。";

        function initWhenReady() {
          if (!(window.google && google.accounts && google.accounts.id)) {
            setTimeout(initWhenReady, 50);
            return;
          }
          try {
            window.handleCredentialResponse = function (response) {
              const idToken = response.credential;
              if (!idToken) {
                err.textContent = "IDトークンが取得できませんでした。";
                return;
              }
              // Apps Script WebApp は script.google.com のラッパー/iframe を経由するため
              // hash(#...) が inner iframe 側へ引き継がれず id_token が落ちることがある。
              // そのため id_token はクエリで渡す（到着後すぐにGAS側でURLから削除する）。
              const u = new URL(returnUrl);
              u.hash = ""; // 念のため
              u.searchParams.delete("id_token");
              u.searchParams.set("id_token", idToken);
              location.replace(u.toString());
            };

            google.accounts.id.initialize({
              client_id: CLIENT_ID,
              callback: handleCredentialResponse,
            });

            google.accounts.id.renderButton(
              document.getElementById("g_id_signin"),
              { theme: "outline", size: "large" },
            );

            // prompt は一旦コメントアウトでもOK（ボタン表示確認が先）
            // google.accounts.id.prompt();
          } catch (e) {
            err.textContent = String(e && e.stack ? e.stack : e);
          }
        }

        initWhenReady();
      }
    </script>
  </body>
</html>
